<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mi cuenta - Muna Booki</title>
  <!-- Tailwind (para prototipado) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Poppins',sans-serif}
    :root{--color-dark-blue:#0A2F5B;--color-teal:#00B2A9;--color-gold:#FFC845}
    .section-title{color:var(--color-dark-blue)}
    .btn-primary{background-color:var(--color-teal);color:#fff}
    .btn-primary:hover{background-color:#009a92}
  </style>
  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-lite.js";

    // 游댢 TU CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBivlKO0Ijt1hvMNyH9aIGXf_7WZwE2tA4",
      authDomain: "munabooki.firebaseapp.com",
      projectId: "munabooki",
      storageBucket: "munabooki.firebasestorage.app",
      messagingSenderId: "585414544600",
      appId: "1:585414544600:web:77026db4856b0111249bad",
      measurementId: "G-HBM4Y2FKMF"
    };

    // 游빑 Planes disponibles (ids estables)
    const PLANS = [
      { id: 'plan-001', name: 'Suscripci칩n Biblioteca M치gica', price: 8900 },
      { id: 'plan-002', name: 'Cuento a Medida (Est치ndar)', price: 18900 },
      { id: 'plan-003', name: 'Cuento Premium', price: 40000 }
    ];

    // Helpers UI
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>document.querySelectorAll(sel);
    const fmt = (v)=> new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0}).format(v);

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app); // Lite, solo lecturas

    let owned = new Set();
    let selected = new Set();

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }

      // Saludo
      const userName = user.displayName || (user.email ? user.email.split('@')[0] : 'Explorador/a');
      $('#hello').textContent = `춰Hola, ${userName}!`;

      // Cargar productos del usuario (user_products/{uid})
      try {
        const ref = doc(db, 'user_products', user.uid);
        const snap = await getDoc(ref);
        const items = (snap.exists() && Array.isArray(snap.data().items)) ? snap.data().items : [];
        owned = new Set(items);
      } catch (e) {
        console.warn('No se pudo leer user_products:', e);
      }

      // Renderizar chips "Mis productos"
      renderOwnedChips();
      // Renderizar lista de planes seleccionables bajo "Mis productos"
      renderPlanSelector();
      // Calcular total inicial
      updateTotal();

      // Cerrar sesi칩n
      $('#logoutBtn').addEventListener('click', async ()=>{
        try { await signOut(auth); } catch(_){}
        window.location.href = 'index.html';
      });
    });

    function renderOwnedChips(){
      const cont = $('#owned-chips');
      cont.innerHTML = '';
      if (owned.size === 0) {
        cont.innerHTML = '<p class="text-gray-500">A칰n no tienes productos.</p>';
        return;
      }
      for (const id of owned){
        const plan = PLANS.find(p=>p.id===id);
        if(!plan) continue;
        const chip = document.createElement('span');
        chip.className = 'inline-flex items-center gap-2 bg-teal-50 text-teal-700 px-3 py-1 rounded-full border border-teal-200 text-sm mr-2 mb-2';
        chip.innerHTML = `<svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-7.25 7.25a1 1 0 01-1.414 0l-3-3a1 1 0 111.414-1.414l2.293 2.293 6.543-6.543a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>${plan.name}`;
        cont.appendChild(chip);
      }
    }

    function renderPlanSelector(){
      const list = $('#plans-list');
      list.innerHTML = '';
      selected.clear();

      for (const plan of PLANS){
        const isOwned = owned.has(plan.id);
        const li = document.createElement('div');
        li.className = 'flex items-start justify-between p-5 rounded-2xl border mb-4 shadow-sm bg-white';

        const left = document.createElement('div');
        left.className = 'flex items-start gap-4';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'mt-1 h-5 w-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500';
        checkbox.disabled = isOwned;
        checkbox.checked = isOwned;
        if (!isOwned) {
          checkbox.addEventListener('change',()=>{
            if (checkbox.checked) selected.add(plan.id); else selected.delete(plan.id);
            updateTotal();
          });
        }

        const titleWrap = document.createElement('div');
        titleWrap.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="font-semibold text-gray-800">${plan.name}</span>
            ${isOwned ? '<span class="text-xs bg-gray-100 text-gray-700 px-2 py-0.5 rounded-full border">Ya lo tienes</span>' : ''}
          </div>
          <div class="text-sm text-gray-500">${fmt(plan.price)}</div>
        `;

        left.appendChild(checkbox);
        left.appendChild(titleWrap);

        const price = document.createElement('div');
        price.className = 'text-gray-700 font-semibold';
        price.textContent = fmt(plan.price);

        li.appendChild(left);
        li.appendChild(price);
        list.appendChild(li);
      }
    }

    function updateTotal(){
      let total = 0;
      for (const id of selected){
        const p = PLANS.find(x=>x.id===id); if (p) total += p.price;
      }
      $('#total-amount').textContent = fmt(total);
      const btn = $('#goCheckout');
      btn.disabled = (total === 0);
      btn.classList.toggle('opacity-60', total===0);
    }

    window._goToCheckout = function(){
      const items = Array.from(selected);
      if (items.length === 0) return;
      const qs = encodeURIComponent(items.join(','));
      window.location.href = `checkout.html?items=${qs}`;
    }
  </script>
</head>
<body class="bg-gray-50">
  <!-- Header -->
  <header class="bg-white shadow-sm">
    <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
      <a href="index.html"><img src="https://bmeryu.github.io/muna-booki/Logo_MunaBooki.png" alt="Muna Booki" class="h-12"/></a>
      <div class="flex items-center gap-4">
        <button id="logoutBtn" class="text-gray-600 hover:text-teal-600 font-semibold">Cerrar sesi칩n</button>
      </div>
    </nav>
  </header>

  <main class="container mx-auto px-6 py-10 max-w-5xl">
    <h1 id="hello" class="text-3xl font-bold section-title mb-2">Mi cuenta</h1>
    <p class="text-gray-600 mb-8">Administra tus productos y contrata nuevos planes.</p>

    <!-- Mis productos -->
    <section class="mb-10">
      <h2 class="text-xl font-semibold text-gray-800 mb-3">Mis productos</h2>
      <div id="owned-chips" class="flex flex-wrap"></div>
    </section>

    <!-- Selector de planes, INCRUSTADO -->
    <section class="bg-white rounded-2xl p-6 shadow-lg">
      <h2 class="text-xl font-bold section-title mb-4">Elige tus planes</h2>
      <div id="plans-list"></div>
      <div class="mt-6 flex items-center justify-between border-t pt-4">
        <span class="text-lg text-gray-800">Total</span>
        <span id="total-amount" class="text-2xl font-extrabold text-gray-900">$0</span>
      </div>
      <div class="mt-4 text-right">
        <button id="goCheckout" class="btn-primary px-5 py-3 rounded-xl font-semibold disabled:cursor-not-allowed" disabled onclick="_goToCheckout()">Continuar al pago</button>
      </div>
      <p class="text-xs text-gray-400 mt-3">Al continuar, te llevaremos al checkout para completar el pago con Mercado Pago.</p>
    </section>
  </main>

  <footer class="py-10 text-center text-sm text-gray-400">춸 Muna Booki</footer>
</body>
</html>

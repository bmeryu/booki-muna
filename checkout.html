<!DOCTYPE html>
}


async function checkAllowlistAndMaybeRedirect(user){
const email = (user.email||'').toLowerCase();
try {
const ref = doc(db, 'allowlist', email);
const snap = await getDoc(ref);
const active = snap.exists() && (snap.data()?.active === true);
showDebug(`exists=${snap.exists()} active=${active}`);
if (active) {
const msg = document.getElementById('free-msg');
msg.classList.remove('hidden');
// Redirige en breve a Mi Cuenta
setTimeout(()=>{ location.href = 'mi-cuenta.html'; }, 900);
return true;
}
} catch (e) {
console.error('allowlist error', e);
}
return false;
}


// Eventos de Auth
document.getElementById('google-signin-btn').addEventListener('click', async ()=>{
try { await signInWithPopup(auth, googleProvider); } catch(e){ console.error(e); }
});
document.getElementById('register-form').addEventListener('submit', async (e)=>{
e.preventDefault();
try { await createUserWithEmailAndPassword(auth, e.target.email.value, e.target.password.value); }
catch (err){ console.error(err); document.getElementById('auth-error-message').textContent = 'No se pudo registrar.'; }
});
document.getElementById('login-form').addEventListener('submit', async (e)=>{
e.preventDefault();
try { await signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value); }
catch (err){ console.error(err); document.getElementById('auth-error-message').textContent = 'Email o contraseña incorrectos.'; }
});


// Tabs simples (estéticos)
document.getElementById('login-tab-btn').addEventListener('click', ()=>{
document.getElementById('register-form').classList.add('hidden');
document.getElementById('login-form').classList.remove('hidden');
});
document.getElementById('register-tab-btn').addEventListener('click', ()=>{
document.getElementById('login-form').classList.add('hidden');
document.getElementById('register-form').classList.remove('hidden');
});


// Start
renderCart();


let handledUid = null;
onAuthStateChanged(auth, async (user)=>{
if (!user) return;
if (handledUid === user.uid) return;
handledUid = user.uid;
showPaymentUI(user);
const isAllow = await checkAllowlistAndMaybeRedirect(user);
// Si NO está en allowlist, se queda y puede pagar
});
</script>
</body>
</html>
